SHELL = /bin/bash
PATH = ./node_modules/.bin:/usr/local/bin:/bin:/usr/bin
MTP_COMMON = ./node_modules/money-to-prisoners-common
GOVUK_ELEMENTS = ./node_modules/mojular-govuk-elements
MOJ_ELEMENTS = ./node_modules/mojular-moj-elements
TESTS = test

MTP_APP = ./mtp_cashbook

ASSETS_TARGET = ./$(MTP_APP)/assets
ASSETS_SOURCE = ./$(MTP_APP)/assets-src
TEMPLATES = ./$(MTP_APP)/templates

JS_PATH = $(ASSETS_TARGET)/scripts
ALL_JS := $(shell find -L $(TESTS) $(ASSETS_SOURCE)/javascripts $(MTP_COMMON)/assets/javascripts -name \*.js)

CSS_PATH = $(ASSETS_TARGET)/stylesheets
ALL_SCSS := $(shell find -L $(ASSETS_SOURCE) $(GOVUK_ELEMENTS) $(MOJ_ELEMENTS) $(MTP_COMMON) -name \*.scss)

SASS_LOAD_PATH = --include-path ./node_modules/hopscotch-highlight/src/stylesheets --include-path ./node_modules/hopscotch/dist/css --include-path ./node_modules/breakpoint-sass/stylesheets --include-path ./node_modules/include-media/dist --include-path ./node_modules/bourbon/app/assets/stylesheets --include-path ./node_modules/susy/sass --include-path $(ASSETS_SOURCE)/stylesheets --include-path $(GOVUK_ELEMENTS)/sass --include-path $(MOJ_ELEMENTS)/sass --include-path $(MTP_COMMON)/assets/scss --include-path $(MTP_COMMON)/assets/scss/elements --include-path ./node_modules

WATCHLIST := $(TESTS) $(ASSETS_SOURCE) $(MTP_COMMON) $(GOVUK_ELEMENTS) $(MOJ_ELEMENTS) $(TEMPLATES)

#################
#### RECIPES ####
#################

.PHONY: all watch clean serve sync start help collect_assets scripts stylesheets

# if no arguments passed, print help message
help:
	@echo "run as: make [watch clean serve sync start all]"

scripts: $(JS_PATH)/app.bundle.js
stylesheets: $(CSS_PATH)/app.css $(CSS_PATH)/app-print.css

# start the server normally
start: images stylesheets scripts
	@echo Starting the Django server
	@./run.sh start > /dev/null


# compile all the things
all: node_modules scripts stylesheets images

# remove all the things
clean:
	rm -rf $(ASSETS_TARGET)

# run normally but monitor assets and recompile them when they change
watch: all
	@echo Monitoring changes
	./run.sh watch $(WATCHLIST)

# as above but also run browser-sync for dynamic browser reload
serve: all
	@./run.sh serve $(WATCHLIST)

images:
	@echo Collecting images
	@mkdir -p ./$(MTP_APP)/assets/images
	@cp $(MTP_COMMON)/assets/images/* $(GOVUK_ELEMENTS)/images/* ./$(MTP_APP)/assets/images


######################
#### FILE TARGETS ####
######################

$(JS_PATH)/app.bundle.js: $(ALL_JS)
	@echo Generating JS
	-@jshint $<
	@webpack

$(CSS_PATH)/app-print.css: $(ALL_SCSS)
	@echo Generating $@
	@node-sass $(SASS_LOAD_PATH) $(ASSETS_SOURCE)/stylesheets/app-print.scss $@ > /dev/null 2>&1

$(CSS_PATH)/app.css: $(ALL_SCSS)
	@echo Generating $@
	@node-sass $(SASS_LOAD_PATH) $(ASSETS_SOURCE)/stylesheets/app.scss $@ > /dev/null 2>&1

node_modules:
	npm install
	@echo "node_modules installed. Don't forget to link to local modules as needed (eg npm link money-to-prisoners-common)"
