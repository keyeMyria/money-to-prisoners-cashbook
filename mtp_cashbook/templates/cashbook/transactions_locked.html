{% extends "base.html" %}
{% load i18n %}
{% load currency %}
{% load mtp_utils %}

{% block content %}
  <header class="ContentHeader">
    <a href="{% url 'dashboard' %}" class="ContentHeader-back">{% trans 'Home' %}</a>
    <h1>{% trans 'Credits in progress' %}</h1>
  </header>

  {% include "includes/message_box.html" %}

  <form method="post" action="" class="locked">
  {% csrf_token %}

  {% if object_list %}

    <div class="help-box">
      <p>{% trans 'Here you can see who is currently processing the credits in your team. You can release them if you need to take over their work.' %}</p>

      <div class="help-box-title" aria-controls="help-box-contents" aria-expanded="true">
        <div></div><a href="#">{%trans "Help" %}</a>
      </div>
      <div class="panel-indent help-box-contents" id="help-box-contents">
        {% blocktrans %}
        <p>If you want to release credits:</p>
        <ul>
          <li>Find your team member under ‘staff name’</li>
          <li>Select the box at the end of the row</li>
          <li>Click ‘Release’ to free up their work</li>
        </ul>
        {% endblocktrans %}
      </div>
    </div>

    {% if form.errors or form.non_field_errors %}
      <div class="error-summary" aria-labelledby="error-summary-heading" tabindex="-1" role="alert">
        <h1 class="error-summary-heading heading-medium" id="error-summary-heading">{% trans 'You have not ticked any credits' %}</h1>

        <ol class="error-summary-list">
          {% for field, errors in form.errors.items %}
            {% with field_obj=form|field_from_name:field %}
            <li><a href="#{{ field_obj.auto_id }}-label">
              {% for error in errors %}
                {% if not forloop.first  %}
                  {% trans 'and' %}
                {% endif %}
                {{ error }}
              {% endfor %}
            </a></li>
            {% endwith %}
          {% endfor %}
        </ol>
      </div>
    {% endif %}

    <div class="batch">

      {% include "cashbook/includes/locked_buttons.html" %}

      <table>
        <thead>
          {% include "cashbook/includes/table_actions.html" with location='header' field_name=form.transactions.html_name print=False %}

          <tr>
            <th>{% trans "Staff name" %}</th>
            <th>{% trans "Credits" %}</th>
            <th>{% trans "Amount (£)" %}</th>
            <th>{% trans "Time in progress" %}</th>
            <th>{% trans "Release" %}</th>
          </tr>
        </thead>

        <tbody>
        {% for transaction_locked_ids, transaction_group in object_list %}
          <tr {% if forloop.counter|divisibleby:2 %}{% else %}class="odd"{% endif %}>
            <td title="{{ transaction_group.owner_prison }}">{{ transaction_group.owner_name }}</td>
            <td class="numeric">{{ transaction_group.locked_count }}</td>
            <td class="numeric">{{ transaction_group.locked_amount|currency }}</td>
            <td>{{ transaction_group.locked_at_earliest|timesince }}</td>
            <td class="check">
              <input
                type="checkbox"
                name="{{ form.transactions.html_name }}"
                value="{{ transaction_locked_ids }}"
                id="check-{{ transaction_group.owner }}"
                class="Checkbox"
                {% if transaction_locked_ids in form.transactions.value %}checked{% endif %}>
              <label for="check-{{ transaction_group.owner }}">{% trans "Select" %}</label>
            </td>
          </tr>
        {% endfor %}
        </tbody>

        <tfoot>
          {% include "cashbook/includes/table_actions.html" with location='footer' field_name=form.transactions.html_name print=False %}
        </tfoot>
      </table>

      {% include "cashbook/includes/locked_buttons.html" %}

    </div>

  {% else %}
    <p>{% trans "No credits in progress" %}</p>
  {% endif %}
  </form>
{% endblock content %}
