{% extends "base.html" %}
{% load i18n %}
{% load currency format_string_date transactions %}

{% block content %}
  <header class="ContentHeader">
    <a href="{% url 'dashboard' %}" class="ContentHeader-back">{% trans "Back to dashboard" %}</a>
    <h1>{% trans "History" %}</h1>
  </header>

  <form method="post" class="print-hidden" action="">
    {% csrf_token %}

    {% if form.errors %}
      <div class="error-summary" aria-labelledby="error-summary-heading" tabindex="-1" role="alert">
        <h1 class="error-summary-heading heading-medium" id="error-summary-heading">{% trans 'There was a problem submitting the form' %}</h1>
        <p>{% trans 'Because of the following problems:' %}</p>

        <ol class="error-summary-list">
          {% for field, errors in form.errors.items %}
            {% with field_obj=form|field_from_name:field %}
              <li>
                {% if field_obj %}
                  <a href="#{{ field_obj.auto_id }}-label">
                  {{ field_obj.label }} —
                {% endif %}
                {% for error in errors %}
                  {% if not forloop.first  %}
                    {% trans 'and' %}
                  {% endif %}
                  {{ error }}
                {% endfor %}
                {% if field_obj %}
                  </a>
                {% endif %}
              </li>
            {% endwith %}
          {% endfor %}
        </ol>
      </div>
    {% endif %}

    {% for field in form %}
      <div id="form-group-{{ field.html_name }}" class="form-group {% if field.errors %}error{% endif %}">
        <label for="{{ field.id_for_label }}" id="{{ field.auto_id }}-label" class="form-label">
          {{ field.label }}
          {% for error in field.errors %}
            <span class="error-message">{{ error }}</span>
          {% endfor %}
        </label>
        {{ field }}
      </div>
    {% endfor %}

    <div><input class="button button-secondary" type="submit" value="{% trans 'Search' %}"></div>
  </form>

  {% if object_list %}

    {% for date, group in object_list|regroup_transactions %}

      <h2>{{ date|format_string_date }}</h2>

      {% for refunded_status, transactions in group %}

        <div class="batch batch-history">

          <h3 class="HistoryHeader {% if refunded_status %}HistoryHeader-Refunded{% endif %}">
            {% if refunded_status %}
              {% trans "Refunded" %}
            {% else %}
              {% trans "Credited" %}
            {% endif %}

            <span class="HistoryHeader-Aside HistoryHeader-AsideRight">{% trans "Total" %}: £{{ transactions|sum_transactions|currency }}</span>

            <a class="u-nojs-hidden HistoryHeader-Aside ShowHide ShowHide-Visible js-ShowHide" href="#HistoryBatch-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
              <span class="ShowHide-Hide">
                {% trans "Collapse" %}
                <b>&minus;</b>
              </span>
              <span class="ShowHide-Show">
                {% trans "Collapsed" %}
                <b>&plus;</b>
              </span>
            </a>
          </h3>

          <table id="HistoryBatch-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
            <thead>
              <tr>
                <th>{% trans "Prisoner no" %}</th>
                <th>{% trans "Prisoner name" %}</th>
                <th>{% trans "Amount" %}</th>
                <th>{% trans "Sender" %}</th>
                <th>{% trans "Payment type" %}</th>
                <th>{% trans "Received at" %}</th>
                <th>{% trans "Credited at" %}</th>
                <th>{% trans "Refunded at" %}</th>
                <th>{% trans "Processed by" %}</th>
              </tr>
            </thead>

            <tbody>
            {% for transaction in transactions %}
              <tr {% if not forloop.counter|divisibleby:2 %}class="odd"{% endif %}>
                <td>{{ transaction.prisoner_number }}</td>
                <td>{{ transaction.prisoner_name }}</td>
                <td class="numeric">&pound;{{ transaction.amount|currency }}</td>
                <td>{{ transaction.sender }}</td>
                <td>{% trans "Bank transfer" %}</td>
                <td>{{ transaction.received_at|format_string_date }}</td>
                <td>
                  {% if transaction.credited %}
                    {{ transaction.credited_at|format_string_date }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  {% if transaction.refunded %}
                    {{ transaction.refunded_at|format_string_date }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>{{ transaction.owner_name|default_if_none:'—' }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>

      {% endfor %}
    {% endfor %}

  {% else %}
    <p>{% trans "No payment history found" %}</p>
  {% endif %}
  </form>

  <p><a href="#print-dialog" class="js-Dialog">{% trans "Print these payments" %}</a></p>
  {% include "cashbook/includes/print_dialog.html" %}

{% endblock content %}
