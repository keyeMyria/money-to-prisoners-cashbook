{% extends "base.html" %}
{% load i18n %}
{% load currency %}
{% load mtp_utils %}
{% load transactions %}

{% block content %}
  <header class="ContentHeader">
    <a href="{% url 'dashboard' %}" class="ContentHeader-back">{% trans 'Home' %}</a>
    <h1>{% trans 'Credit history' %}</h1>
  </header>

  <div class="help-box">
    <p>{% trans "Below you'll find all the credits listed to date. You can also use the search to find specific credits." %}</p>

    <div class="help-box-title" aria-controls="help-box-contents" aria-expanded="true" role="heading">
      <div></div><a href="#">{%trans "Help" %}</a>
    </div>
    <div class="panel-indent help-box-contents" id="help-box-contents">
      {% blocktrans trimmed %}
      <p>To help with your search:</p>
      <ul>
        <li>Search by prisoner name, prisoner number, sender name or amount</li>
        <li>To bring up the whole history, don’t enter search dates although you can enter start and finish dates if you have a specific search</li>
        <li>Click on ‘Expand’ to see a list of credits for that day, then click on ‘Collapse’ to go back</li>
        <li>Remember the payments in ‘Uncredited’ haven’t been processed yet</li>
      </ul>
      {% endblocktrans %}
    </div>
  </div>

  {% include "includes/message_box.html" %}

  <form method="get" class="print-hidden HistorySearch" action="">
    {% include 'mtp_utils/forms/error-summary.html' with form=form only %}

    <div class="form-inputs">
      <div class="search-field">
        {% include 'mtp_utils/forms/field.html' with field=form.search only %}
      </div>

      <div class="date-fields">
        <div class="date-start">
          {% include 'mtp_utils/forms/field.html' with field=form.start input_classes='js-FormDateControl' value=form.start.value|date:'d/m/Y'|default:form.start.value|default_if_none:'' only %}
        </div>
        <div class="date-end">
          {% include 'mtp_utils/forms/field.html' with field=form.end input_classes='js-FormDateControl' value=form.end.value|date:'d/m/Y'|default:form.end.value|default_if_none:'' only %}
        </div>
      </div>
    </div>

    {# always forces a search to start on page 1 #}
    <input type="hidden" name="{{ form.page.html_name }}" value="1">

    <div><input class="button button-secondary" type="submit" value="{% trans 'Search' %}"></div>
  </form>


  <div class="batch batch-history">
    {% if object_list %}

      <p class="HistoryDescription">{{ form.get_search_description }}</p>

      {% for transaction_date, group in object_list|parse_date_fields|regroup_transactions %}
        <h3>{{ transaction_date|date:'DATE_FORMAT' }}</h3>

        {% for transaction_status, transactions in group %}
          <table id="HistoryBatch-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
            <caption
              class="HistoryHeader {% if transaction_status == 'uncredited' %}HistoryHeader-uncredited{% elif transaction_status == 'refunded' %}HistoryHeader-refunded{% endif %}">
                {% if transaction_status == 'uncredited' %}
                  {% trans 'Uncredited' %}
                {% elif transaction_status == 'refunded' %}
                  {% trans 'Refunded' %}
                {% else %}
                  {% trans 'Credited' %}
                {% endif %}
              <span class="HistoryHeader-aside HistoryHeader-aside-right">{% trans 'Total' %}: £{{ transactions|sum_transactions|currency }}</span>
            </caption>
            <thead>
              <tr>
                <th>{% trans 'Prisoner no' %}</th>
                <th>{% trans 'Prisoner name' %}</th>
                <th>{% trans 'Amount (£)' %}</th>
                <th>{% trans 'Sender' %}</th>
                <th>
                  {% if transaction_status == 'uncredited' %}
                    {% trans 'Started by' %}
                  {% else %}
                    {% trans 'Finished by' %}
                  {% endif %}
                </th>
              </tr>
            </thead>
            <tbody>
              {% for transaction in transactions %}
                <tr {% if not forloop.counter|divisibleby:2 %}class="odd"{% endif %}>
                  <td>{{ transaction.prisoner_number }}</td>
                  <td>{{ transaction.prisoner_name }}</td>
                  <td class="numeric">{{ transaction.amount|currency }}</td>
                  <td>{{ transaction.sender }}</td>
                  <td>{{ transaction.owner_name|default_if_none:'—' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endfor %}
      {% endfor %}

      {% if page_range %}
        <ul class="Pagination print-hidden">
          {% if previous_page %}
            <li><a href="{% url_with_query_param request 'page' previous_page %}">{% trans 'Previous' %}</a></li>
          {% endif %}
          {% for page in page_range %}
            <li><a href="{% url_with_query_param request 'page' page %}" class="{% if page == current_page %}current-page{% endif %}">{{ page }}</a></li>
          {% endfor %}
          {% if next_page %}
            <li><a href="{% url_with_query_param request 'page' next_page %}">{% trans 'Next' %}</a></li>
          {% endif %}
        </ul>
        <p class="Pagination-print-description">{% blocktrans with page=current_page pages=page_count %}Page {{ page }} of {{ pages }}.{% endblocktrans %}</p>
      {% endif %}

      <p><a href="#print-dialog" class="js-Dialog print-hidden">{% trans 'Print this page of credits' %}</a></p>
      {% include 'cashbook/includes/print_dialog.html' %}

    {% else %}

      <table>
        <thead>
          <tr>
            <th>{% trans 'No credit history found' %}</th>
          </tr>
        </thead>
      </table>

    {% endif %}
  </div>

{% endblock content %}
