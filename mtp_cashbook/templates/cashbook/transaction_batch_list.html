{% extends "base.html" %}
{% load currency moj_utils i18n %}

{% block page_title %}{% trans "New credits - Digital cashbook" %}{% endblock %}

{% block template_type %}v-batch{% endblock %}

{% block content %}

  <header class="ContentHeader">
    <a href="{% url 'transaction-discard' %}" class="ContentHeader-back" id="tour-step7">{% trans 'Home' %}</a>
    <h1>{% trans 'New credits' %}</h1>
  </header>

  <form
    method="post"
    action=""
    class="js-BeforeUnload js-BatchValidation"
    data-transactions-name="{{ form.transactions.html_name }}"
    data-unload-msg="{% trans "You are leaving this page, but have ticked credits. &#x0A;&#x0A; Click ‘Done’ if credits have been processed in NOMIS." %}">
    {% csrf_token %}


    {% if object_list %}
      {% if form.errors or form.non_field_errors %}
        <div class="error-summary" aria-labelledby="error-summary-heading" tabindex="-1" role="alert">
          <h1 class="error-summary-heading heading-medium" id="error-summary-heading">{% trans 'You have not ticked any credits' %}</h1>

          <ol class="error-summary-list">
            {% for field, errors in form.errors.items %}
              {% with field_obj=form|field_from_name:field %}
              <li><a href="#{{ field_obj.auto_id }}-label">
                {% for error in errors %}
                  {% if not forloop.first  %}
                    {% trans 'and' %}
                  {% endif %}
                  {{ error }}
                {% endfor %}
              </a></li>
              {% endwith %}
            {% endfor %}
          </ol>
        </div>
      {% endif %}


      <div class="batch">
        <div class="totals js-StickyHeader"  id="tour-step-total">
          <div class="container js-RunningTotal" data-label="{% trans 'Credits processed in NOMIS' %}">
            <p>
              <span>{% trans 'Control total' %}</span>
              <span>&pound;{{total|currency}}</span>
            </p>
          </div>
        </div>

        {% include "cashbook/includes/batch_buttons.html" %}

        <div class="print-box">
          {% trans "Remember to click 'Done' in the digital cashbook when you’ve processed credits in NOMIS." %}
        </div>

        <table id="tour-step1">
          <thead>
            {% include "cashbook/includes/table_actions.html" with location='header' field_name=form.transactions.html_name %}

            <tr>
              <th id="tour-step2">{% trans "Prisoner no" %}</th>
              <th id="tour-step3">{% trans "Prisoner name" %}</th>
              <th id="tour-step4">{% trans "Amount" %}</th>
              <th>{% trans "Sender" %}</th>
              <th id="tour-step5"><span id="id_transactions-label">{% trans "Credited?" %}</span></th>
            </tr>
          </thead>

          <tbody>
          {% for transaction_pk, transaction in object_list %}
            <tr {% if forloop.counter|divisibleby:2 %}{% else %}class="odd"{% endif %}>
              <td>{{ transaction.prisoner_number }}</td>
              <td>{{ transaction.prisoner_name }}</td>
              <td class="numeric">&pound;{{ transaction.amount|currency }}</td>
              <td>{{ transaction.sender }}</td>
              <td class="check">
                <input
                  type="checkbox"
                  name="{{ form.transactions.html_name }}"
                  value="{{ transaction_pk }}"
                  id="check-{{ transaction.id }}"
                  {% if transaction_pk|to_string in form.transactions.value %}checked{% endif %}
                  class="js-RunningTotal-item"
                  data-amount="{{ transaction.amount|currency }}">
                <label for="check-{{ transaction.id }}">{% trans "Credited" %}</label>
              </td>
            </tr>
          {% endfor %}
          </tbody>

          <tfoot>
            {% include "cashbook/includes/table_actions.html" with location='footer' field_name=form.transactions.html_name %}
          </tfoot>
        </table>

        {% include "cashbook/includes/batch_buttons.html" %}

      </div>
    {% else %}
      <p>{% trans "No transactions found" %}</p>
    {% endif %}

    </div>

    <dialog id="incomplete-batch-dialog" class="Dialog u-nojs-hidden" data-hide-close="true" data-disable-backdrop-close="true">
      <div class="Dialog-inner">
        <h3>{% trans "Are you sure?" %}</h3>
        <p>{% trans "Do you want to submit only the selected credits?" %}</p>
        <button type="submit" class="button" value="override">{% trans "Yes" %}</button>
        <button type="button" class="button button-secondary js-Dialog-close">{% trans "No, continue processing" %}</button>
      </div>
    </dialog>
  </form>

  {% include "cashbook/includes/print_dialog.html" %}

{% endblock content %}

{% block main_js %}
  <script>
    var tour = {
      id: 'batch',
      steps: [
        {
          content: '{% blocktrans %}<p>This table shows credits to be processed in NOMIS.</p>{% endblocktrans %}',
          target: 'tour-step1',
          padding: 10,
          placement: 'top',
          xOffset: 'center',
          highlight: true
        },
        {
          content: '{% blocktrans %}<p>Start by entering the control total in NOMIS then use the ‘misc receipt - private cash’ category as Transaction Type in NOMIS.</p><p>A running total of ticked credits will be displayed here.</p>{% endblocktrans %}',
          target: 'tour-step-total',
          padding: 10,
          placement: 'bottom',
          xOffset: 'center',
          highlight: true
        },
        {
          content: '{% blocktrans %}<p>Enter the prisoner number in NOMIS.</p>{% endblocktrans %}',
          target: 'tour-step2',
          padding: 10,
          placement: 'top',
          arrowOffset: 52,
          table: 'column',
          highlight: true
        },
        {
          content: '{% blocktrans %}<p>Check prisoner\'s names match.</p>{% endblocktrans %}',
          target: 'tour-step3',
          padding: 10,
          placement: 'top',
          xOffset: 'center',
          table: 'column',
          highlight: true
        },
        {
          content: '{% blocktrans %}<p>Add credit amount.</p>{% endblocktrans %}',
          target: 'tour-step4',
          padding: 10,
          placement: 'top',
          xOffset: 'center',
          table: 'column',
          highlight: true
        },
        {
          content: '{% blocktrans %}<p>Keep track by ticking credits you\'ve processed in NOMIS.</p>{% endblocktrans %}',
          target: 'tour-step5',
          padding: 10,
          placement: 'top',
          xOffset: -204,
          arrowOffset: 252,
          table: 'column',
          highlight: true
        },
        {
          content: '{% blocktrans %}<p>Click ‘Done’ when you\'ve processed credits to NOMIS.</p>{% endblocktrans %}',
          target: 'tour-step6',
          padding: 10,
          placement: 'bottom',
          xOffset: 'center',
          highlight: true
        },
        {
          content: '{% blocktrans %}<p>Click ‘Home’ to return to the home page.</p>{% endblocktrans %}',
          target: 'tour-step7',
          padding: 10,
          placement: 'bottom',
          xOffset: 0,
          arrowOffset: 20,
          highlight: true
        }
      ]
    };
  </script>

  {{ block.super }}
{% endblock %}
